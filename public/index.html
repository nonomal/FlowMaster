<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 添加网站图标 -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- SEO Meta 标签 -->
    <title>FlowMaster | 专业的网络流量实时监控系统</title>
    <meta name="description" content="FlowMaster是一款专业的网络流量监控系统，提供实时流量统计、历史数据查询、多接口支持等功能，帮助您更好地管理和分析网络流量。">
    <meta name="keywords" content="FlowMaster,流量监控,网络监控,流量统计,网络流量分析,实时监控">
    <meta name="author" content="vbskycn">
    
    <!-- Open Graph Meta 标签 (用于社交媒体分享) -->
    <meta property="og:title" content="FlowMaster | 专业的网络流量实时监控系统">
    <meta property="og:description" content="专业的网络流量监控系统，提供实时流量统计、历史数据查询、多接口支持等功能。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://github.com/vbskycn/FlowMaster">
    
    <!-- Twitter Card Meta 标签 -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="FlowMaster | 专业的网络流量实时监控系统">
    <meta name="twitter:description" content="专业的网络流量监控系统，提供实时流量统计、历史数据查询、多接口支持等功能。">
    
    <!-- 移动设备优化 -->
    <meta name="theme-color" content="#4a90e2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <!-- 搜索引擎指令 -->
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://github.com/vbskycn/FlowMaster">

    <!-- 结构化数据 (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "SoftwareApplication",
        "name": "FlowMaster",
        "description": "专业的网络流量实时监控系统，提供实时流量统计、历史数据查询、多接口支持等功能。",
        "applicationCategory": "NetworkMonitoringTool",
        "operatingSystem": "All",
        "author": {
            "@type": "Person",
            "name": "vbskycn",
            "url": "https://github.com/vbskycn"
        },
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        }
    }
    </script>

    <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/vue/3.2.31/vue.global.min.js"></script>
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/axios/0.26.0/axios.min.js"></script>
    <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-icons/1.8.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-size: 14px;  /* 基础字体大小 */
            overflow-x: auto; /* 添加横向滚动 */
        }
        .loading {
            position: relative;
            opacity: 0.7;
        }
        [v-cloak] {
            display: none;
        }
        .update-time {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .refresh-control {
            margin-bottom: 15px;
        }
        /* 修改版本号标签样式 */
        .version-badge {
            background-color: #f8f9fa;     /* 浅灰色背景 */
            color: #6c757d;                /* 深灰色文字 */
            border: 1px solid #dee2e6;     /* 浅色边框 */
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 500;
            border-radius: 0.25rem;
        }

        /* 响应式设计调整 */
        @media (max-width: 768px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .card-header {
                padding: 0.75rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            pre {
                font-size: 11px;
                padding: 8px;
            }
            
            .version-badge {
                font-size: 0.7em;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .footer {
                padding: 1rem 0;
            }
            
            .footer-links {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .footer-separator {
                display: none; /* 移动端隐藏分隔符 */
            }
            
            .footer-link {
                margin: 5px 0;
            }
        }

        /* 平板设备优化 */
        @media (min-width: 769px) and (max-width: 1024px) {
            pre {
                font-size: 13px;
            }
            
            .card {
                margin-bottom: 20px;
            }
        }

        /* 确保在不同设备上的卡片布局 */
        @media (max-width: 576px) {
            .col-md-6 {
                width: 100%;
            }
        }

        /* 添加暗色模式全局样式 */
        /* 添加更好的加载状态样式 */
        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 添加平滑过渡效果 */
        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        pre {
            transition: all 0.3s ease;
        }

        /* 数据更新动画 */
        @keyframes update-flash {
            0% { background-color: rgba(13, 110, 253, 0.1); }
            100% { background-color: transparent; }
        }

        .data-updated {
            animation: update-flash 1s ease;
        }

        /* 添加中等屏幕优化 */
        @media (min-width: 769px) and (max-width: 1200px) {
            .container {
                max-width: 95%;
            }
        }

        /* 提高可访问性 */
        .form-select:focus,
        .form-check-input:focus,
        .github-link:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }

        /* 提高对比度 */
        .text-muted {
            color: #666 !important;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        .date-query .form-control {
            background-color: var(--input-bg, #fff);
            color: var(--input-color, #212529);
            border-color: var(--input-border, #dee2e6);
        }
        
        .date-query .btn-primary {
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .date-query .col-md-4 {
                margin-bottom: 1rem;
            }
        }
        
        /* 暗色模式支持 */
        /* 调整顶部布局样式 */
        .refresh-control {
            min-width: 150px;
        }
        
        .update-time {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        /* 调整日期查询样式 */
        .card-body.py-2 {
            padding-top: 0.75rem !important;
            padding-bottom: 0.75rem !important;
        }
        
        .form-label.small {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .form-control-sm {
            height: calc(1.5em + 0.5rem + 2px);
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        /* 调整间距 */
        .mb-3 {
            margin-bottom: 1rem !important;
        }
        
        .py-4 {
            padding-top: 1.5rem !important;
            padding-bottom: 1.5rem !important;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .refresh-control {
                margin-top: 1rem;
                text-align: left !important;
            }
            
            .d-flex.justify-content-between {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header class="container py-4">
        <div id="app">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <h1 class="mb-0">FlowMaster 流量监控</h1>
                    <span class="version-badge ms-3" v-cloak>v{{version}}</span>
                </div>
                <div class="refresh-control text-end">
                    <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input" type="checkbox" v-model="autoRefresh" id="autoRefreshSwitch">
                        <label class="form-check-label" for="autoRefreshSwitch">
                            自动刷新
                        </label>
                    </div>
                    <!-- 主题切换开关 -->
                    <button class="btn btn-sm ms-2" :class="isDarkMode ? 'btn-dark' : 'btn-light'" @click="toggleTheme" :aria-label="isDarkMode ? '切换为浅色' : '切换为深色'" style="vertical-align:middle;">
                        <span v-if="isDarkMode">🌙</span>
                        <span v-else>☀️</span>
                    </button>
                    <div class="update-time" v-if="lastUpdateTime">
                        最后更新: {{lastUpdateTime}}
                    </div>
                </div>
            </div>

            <div v-if="error" class="alert alert-danger" v-cloak>
                {{error}}
            </div>

            <div class="row align-items-center mb-3">
                <div class="col-md-4">
                    <select v-model="selectedInterface" class="form-select" @change="loadAllStats" v-cloak>
                        <option v-for="interface in interfaces" :key="interface" :value="interface">
                            {{interface}}
                        </option>
                    </select>
                </div>
                <div class="col-md-8">
                    <p class="text-muted mb-0 mt-2 mt-md-0" v-cloak>
                        当前选择的网络接口: {{selectedInterface}}
                    </p>
                </div>
            </div>

            <div class="card mb-3" v-cloak>
                <div class="card-body py-2">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label small mb-1">开始日期</label>
                            <input type="date" class="form-control form-control-sm" id="startDate" v-model="dateRange.start">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label small mb-1">结束日期</label>
                            <input type="date" class="form-control form-control-sm" id="endDate" v-model="dateRange.end">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary btn-sm w-100" @click="queryDateRange" :disabled="!isDateRangeValid">
                                查询
                            </button>
                        </div>
                        <div class="col-md-2" v-if="dateRangeStats.data.length">
                            <button type="button" class="btn btn-outline-secondary btn-sm w-100" @click="clearDateRangeStats">
                                清除
                            </button>
                        </div>
                    </div>
                    
                    <!-- 查询结果显示 -->
                    <div v-if="dateRangeStats.data.length" class="mt-2">
                        <pre class="mb-0 small">{{dateRangeStats.data.join('\n')}}</pre>
                    </div>
                </div>
            </div>

            <div class="row" v-cloak>
                <div class="col-md-12 mb-4">
                    <div class="card" :class="{ loading: realtimeStats.loading }">
                        <div class="card-header">
                            <h5 class="card-title mb-0">实时统计</h5>
                        </div>
                        <div class="card-body">
                            <!-- 实时流量图表 -->
                            <div class="chart-container" style="height:200px;margin-bottom:15px;">
                                <canvas ref="realtimeChart" style="width:100%;height:100%;"></canvas>
                            </div>
                            <!-- 实时流量表格 -->
                            <div ref="realtimeTable" style="max-height:300px;overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 mb-4">
                    <div class="card" :class="{ loading: minuteStats.loading }">
                        <div class="card-header">
                            <h5 class="card-title mb-0">分钟统计</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height:180px;">
                                <canvas ref="minuteChart" style="width:100%;height:100%;"></canvas>
                            </div>
                            <div v-html="renderTableHtml(formatTableDataUnified(minuteStats.data, minuteStats.unit, minuteStats.factor), minuteStats.unit)"></div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4" v-for="(stat, index) in stats" :key="index">
                    <div class="card" :class="{ loading: stat.loading }">
                        <div class="card-header">
                            <h5 class="card-title mb-0">{{stat.title}}</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height:180px;">
                                <canvas :ref="'statChart' + index" style="width:100%;height:100%;"></canvas>
                            </div>
                            <div v-html="renderTableHtml(formatTableDataUnified(stat.data, stat.unit, stat.factor), stat.unit)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main role="main">
        <!-- ... 原有的主要内容 ... -->
    </main>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <span class="footer-text">FlowMaster</span>
                    <span class="version-badge ms-2" v-cloak>v{{version}}</span>
                    <span class="copyright-text ms-3">© 2025 by 
                        <a href="https://www.zhoujie218.top" target="_blank" class="author-link">zhoujie218</a>
                    </span>
                </div>
                <a href="https://github.com/vbskycn/FlowMaster" target="_blank" class="github-link">
                    <i class="bi bi-github"></i> GitHub
                </a>
            </div>
        </div>
    </footer>

    <!-- 使用稳定版本的 Bootstrap Icons CDN -->
    

    <!-- Chart.js CDN -->
    

    <!-- 更新页脚样式 -->
    <style>
        .footer {
            border-top: 1px solid #eee;
            padding: 15px 0;
            margin-top: auto;
            background-color: #fff;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-brand {
            display: flex;
            align-items: center;
        }

        .footer-text {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .copyright-text {
            color: #666;
            font-size: 14px;
        }

        .author-link {
            color: #666;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .author-link:hover {
            color: #333;
            text-decoration: underline;
        }

        .github-link {
            color: #666;
            font-size: 14px;
            text-decoration: none;
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .github-link i {
            font-size: 18px;
        }

        .github-link:hover {
            color: #333;
        }

        /* 暗色模式支持 */
        @media (prefers-color-scheme: dark) {
            .footer {
                background-color: #1a1a1a;
                border-top-color: #2d2d2d;
            }

            .footer-text,
            .copyright-text,
            .author-link {
                color: #a0a0a0;
            }

            .author-link:hover,
            .github-link:hover {
                color: #ffffff;
            }
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .footer {
                padding: 12px 0;
            }
            
            .footer-content {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                text-align: center;
            }

            .footer-brand {
                flex-direction: column;
                gap: 5px;
            }

            .copyright-text {
                margin-left: 0 !important;
            }
        }
    </style>
    <!-- 优化深色主题配色，提升表头、表格、控件可读性和美观性 -->
    <style>
        body.dark .table {
            background-color: transparent;
            color: #f1f5fa;
            border-color: rgba(255,255,255,0.08);
        }
        body.dark .table-bordered > :not(caption) > * > * {
            border-color: rgba(255,255,255,0.08);
        }
        body.dark .table thead th, body.dark .table thead td {
            background-color: #23272e;
            color: #f1f5fa;
            border-bottom: 2px solid rgba(255,255,255,0.12);
        }
        body.dark .table tbody tr {
            background-color: #181b20 !important;
        }
        body.dark .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: #23272e !important;
        }
        body.dark .table-striped > tbody > tr:nth-of-type(even) {
            background-color: #181b20 !important;
        }
        body.dark .table tbody td, body.dark .table tbody th {
            color: #fff;
        }
        body.dark .table th, body.dark .table td {
            border-color: rgba(255,255,255,0.08);
        }
        body.dark .table-hover > tbody > tr:hover {
            background-color: #23272e !important;
        }
        body.dark .table thead {
            border-bottom: 2px solid rgba(255,255,255,0.12);
        }
        body.dark .btn-dark, body.dark .btn-light {
            background-color: #23272e;
            color: #fff;
            border: 1px solid #3d3d3d;
        }
        body.dark .btn-dark:hover, body.dark .btn-light:hover {
            background-color: #31363f;
            color: #fff;
        }
        body.dark .form-select {
            background-color: #23272e;
            color: #fff;
            border-color: #3d3d3d;
        }
        body.dark .form-select:focus {
            background-color: #23272e;
            color: #fff;
            border-color: #0d6efd;
        }
        body.dark .form-check-input {
            background-color: #23272e;
            border-color: #3d3d3d;
        }
        body.dark .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        body.dark .version-badge {
            background-color: #23272e;
            border-color: #3d3d3d;
            color: #b0b8c1;
        }
        body.dark .footer {
            background-color: #1a1a1a;
            border-top-color: #2d2d2d;
        }
        body.dark .footer-text,
        body.dark .copyright-text,
        body.dark .author-link {
            color: #b0b8c1;
        }
        body.dark .author-link:hover,
        body.dark .github-link:hover {
            color: #fff;
        }
        /* 优化表格滚动条 */
        body.dark ::-webkit-scrollbar {
            background: #23272e;
        }
        body.dark ::-webkit-scrollbar-thumb {
            background: #444;
        }
        body.dark .table td, body.dark .table th {
            background-color: inherit !important;
            color: #f1f5fa;
        }
    </style>
    <!-- 追加body.dark样式覆盖，确保主题切换立即生效 -->
    <style>
        body.dark {
            background-color: #1a1a1a;
            color: #fff;
        }
        body.dark .card {
            background-color: #2d2d2d;
            border-color: #3d3d3d;
        }
        body.dark .card-header {
            background-color: #252525;
            border-bottom-color: #3d3d3d;
        }
        body.dark pre {
            background: #252525;
            color: #fff;
        }
        body.dark .text-muted {
            color: #a0a0a0 !important;
        }
        body.dark .version-badge {
            background-color: #2d2d2d;
            border-color: #3d3d3d;
            color: #a0a0a0;
        }
        body.dark .form-select {
            background-color: #2d2d2d;
            color: #fff;
            border-color: #3d3d3d;
        }
        body.dark .form-select:focus {
            background-color: #2d2d2d;
            color: #fff;
            border-color: #0d6efd;
        }
        body.dark .form-check-input {
            background-color: #2d2d2d;
            border-color: #3d3d3d;
        }
        body.dark .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        body.dark .footer {
            background-color: #1a1a1a;
            border-top-color: #2d2d2d;
        }
        body.dark .footer-text,
        body.dark .copyright-text,
        body.dark .author-link {
            color: #a0a0a0;
        }
        body.dark .author-link:hover,
        body.dark .github-link:hover {
            color: #fff;
        }
    </style>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    interfaces: [],
                    selectedInterface: 'eth0',
                    error: null,
                    realtimeStats: { data: [], loading: false },
                    minuteStats: { data: [], loading: false },
                    stats: [
                        { period: 'h', title: '小时统计', data: [], loading: false },
                        { period: 'd', title: '日统计', data: [], loading: false },
                        { period: 'm', title: '月统计', data: [], loading: false },
                        { period: 'y', title: '年统计', data: [], loading: false }
                    ],
                    autoRefresh: false,
                    refreshInterval: null,
                    lastUpdateTime: '',
                    version: '',
                    dateRange: {
                        start: '',
                        end: ''
                    },
                    dateRangeStats: {
                        data: [],
                        loading: false
                    },
                    isDarkMode: false,
                    realtimeData: [] // 存储最近20条实时数据记录
                }
            },
            computed: {
                isDateRangeValid() {
                    return this.dateRange.start && this.dateRange.end && 
                           this.dateRange.start <= this.dateRange.end;
                }
            },
            methods: {
                async loadInterfaces() {
                    try {
                        const response = await axios.get('/api/interfaces');
                        // 对接口列表进行排序
                        this.interfaces = response.data.interfaces.sort((a, b) => {
                            // 定义接口优先级函数
                            const getPriority = (name) => {
                                // 常见物理网卡接口优先
                                if (name.startsWith('eth')) return 1;
                                if (name.startsWith('ens')) return 2;
                                if (name.startsWith('enp')) return 3;
                                // 其他常见网卡接口
                                if (name.startsWith('wlan')) return 10;
                                if (name.startsWith('bond')) return 11;
                                if (name.startsWith('br-')) return 12;
                                // 虚拟和容器接口靠后
                                if (name.startsWith('docker')) return 100;
                                if (name.includes('veth') || 
                                    name.includes('virbr') || 
                                    name.includes('tun') || 
                                    name.includes('tap')) return 101;
                                return 50; // 其他接口
                            };
                            
                            const priorityA = getPriority(a);
                            const priorityB = getPriority(b);
                            
                            // 首先按优先级排序
                            if (priorityA !== priorityB) {
                                return priorityA - priorityB;
                            }
                            
                            // 优先级相同时按字母顺序排序
                            return a.localeCompare(b);
                        });

                        // 选择第一个接口作为默认值
                        if (this.interfaces.length > 0) {
                            this.selectedInterface = this.interfaces[0];
                            this.loadAllStats();
                        }
                    } catch (error) {
                        this.error = '无法获取网络接口列表: ' + (error.response?.data?.error || error.message);
                    }
                },
                parseStatData(data, unit = 'MiB') {
                    // 解析stat.data，返回 { labels: [], rx: [], tx: [] }
                    let labels = [];
                    let rx = [];
                    let tx = [];
                    let headerIdx = -1;
                    let rxIdx = -1, txIdx = -1, labelIdx = 0;
                    let started = false;
                    for (let i = 0; i < data.length; i++) {
                        const line = data[i].trim();
                        if (!line) continue;
                        if (line.includes('---')) { started = true; continue; }
                        if (!started) {
                            // 识别表头
                            headerIdx = i;
                            const header = data[i].replace(/\s+/g, ' ').trim().split(' ');
                            rxIdx = header.findIndex(h => h.startsWith('接收'));
                            txIdx = header.findIndex(h => h.startsWith('发送'));
                            labelIdx = 0; // 通常第一个是时间/日期
                            continue;
                        }
                        // 解析数据行
                        const cols = line.replace(/\s+/g, ' ').trim().split(' ');
                        if (cols.length < Math.max(rxIdx, txIdx) + 1) continue;
                        // 跳过合计/平均/预计等行
                        if (/总计|平均|预计|total|avg|est/.test(cols[labelIdx])) continue;
                        labels.push(cols[labelIdx]);
                        rx.push(this.extractPureNumber(cols[rxIdx]));
                        tx.push(this.extractPureNumber(cols[txIdx]));
                    }
                    return { labels, rx, tx };
                },
                extractPureNumber(val) {
                    // 只提取数值部分，不做单位换算
                    if (!val) return 0;
                    const match = val.match(/([\d.]+)/);
                    if (!match) return 0;
                    return parseFloat(match[1]);
                },
                getBestUnitAndFactor(arr) {
                    // 计算最佳单位和换算因子，支持MiB/GiB/TiB
                    const max = Math.max(...arr);
                    if (max >= 1024 * 1024) return { unit: 'TiB', factor: 1 / (1024 * 1024) };
                    if (max >= 1024) return { unit: 'GiB', factor: 1 / 1024 };
                    return { unit: 'MiB', factor: 1 };
                },
                // 新：格式化表格数据为统一单位且移除原始单位
                formatTableDataUnified(data, unit, factor) {
                    let result = [];
                    let started = false;
                    let rxIdx = -1, txIdx = -1, totalIdx = -1;
                    for (let i = 0; i < data.length; i++) {
                        let line = data[i];
                        if (!started && line.includes('---')) { started = true; result.push(line); continue; }
                        if (!started) {
                            // 处理表头，标注单位
                            let header = line.replace(/\s+/g, ' ').trim().split(' ');
                            rxIdx = header.findIndex(h => h === '接收' || h.toLowerCase() === 'rx');
                            txIdx = header.findIndex(h => h === '发送' || h.toLowerCase() === 'tx');
                            totalIdx = header.findIndex(h => h === '总计' || h.toLowerCase() === 'total');
                            if (rxIdx !== -1) header[rxIdx] += `(${unit})`;
                            if (txIdx !== -1) header[txIdx] += `(${unit})`;
                            if (totalIdx !== -1) header[totalIdx] += `(${unit})`;
                            result.push(header.join(' '));
                            continue;
                        }
                        // 只处理数据行
                        let cols = line.replace(/\s+/g, ' ').trim().split(' ');
                        if (cols.length < Math.max(rxIdx, txIdx, totalIdx) + 1) { result.push(line); continue; }
                        // 跳过合计/平均/预计等行
                        if (/总计|平均|预计|total|avg|est/.test(cols[0])) { result.push(line); continue; }
                        // 格式化数值并移除原单位
                        if (rxIdx !== -1) cols[rxIdx] = this.formatValueToUnitNoUnit(cols[rxIdx], factor);
                        if (txIdx !== -1) cols[txIdx] = this.formatValueToUnitNoUnit(cols[txIdx], factor);
                        if (totalIdx !== -1) cols[totalIdx] = this.formatValueToUnitNoUnit(cols[totalIdx], factor);
                        result.push(cols.join(' '));
                    }
                    return result;
                },
                formatValueToUnitNoUnit(val, factor) {
                    // 提取数值并换算为目标单位，保留两位小数，不显示原单位
                    const match = val.match(/([\d.]+)/);
                    if (!match) return val;
                    let num = parseFloat(match[1]);
                    if (isNaN(num)) return val;
                    return (num * factor).toFixed(2);
                },
                renderMinuteChart() {
                    if (this._minuteChart) this._minuteChart.destroy();
                    const ctx = this.$refs.minuteChart;
                    // 修复自动刷新导致canvas高度异常
                    if (ctx) {
                        ctx.height = 180;
                        // 新增：动态设置canvas宽度为父容器宽度
                        const parent = ctx.parentElement;
                        if (parent) {
                            ctx.width = parent.clientWidth;
                        }
                    }
                    // 5分钟卡片单位固定为MiB
                    const unit = 'MiB';
                    const { labels, rx, tx } = this.parseStatData(this.minuteStats.data, unit);
                    if (!labels.length) return;
                    this._minuteChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [
                                { label: `接收(${unit})`, data: rx, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.08)', tension: 0.3, fill: true },
                                { label: `发送(${unit})`, data: tx, borderColor: '#fb923c', backgroundColor: 'rgba(251,146,60,0.08)', tension: 0.3, fill: true }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: true }, tooltip: { enabled: true } },
                            scales: { y: { beginAtZero: true, title: { display: true, text: unit } } }
                        }
                    });
                },
                renderStatChart(index) {
                    if (!this._statCharts) this._statCharts = [];
                    if (this._statCharts[index]) this._statCharts[index].destroy();
                    // 兼容ref为数组或单个元素
                    let ctx = this.$refs['statChart' + index];
                    if (Array.isArray(ctx)) ctx = ctx[0];
                    // 修复自动刷新导致canvas高度异常
                    if (ctx) {
                        ctx.height = 180;
                        // 新增：动态设置canvas宽度为父容器宽度
                        const parent = ctx.parentElement;
                        if (parent) {
                            ctx.width = parent.clientWidth;
                        }
                    }
                    // 根据周期强制单位
                    let unit = 'MiB';
                    const period = this.stats[index].period;
                    if (period === 'd' || period === 'm') unit = 'GiB';
                    if (period === 'y') unit = 'TiB';
                    const { labels, rx, tx } = this.parseStatData(this.stats[index].data, unit);
                    if (!labels.length) return;
                    // 年统计用柱状图，其余用折线图
                    const chartType = period === 'y' ? 'bar' : 'line';
                    this._statCharts[index] = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels,
                            datasets: [
                                { label: `接收(${unit})`, data: rx, backgroundColor: period === 'y' ? '#2563eb' : 'rgba(37,99,235,0.08)', borderColor: '#2563eb', tension: 0.3, fill: period !== 'y' },
                                { label: `发送(${unit})`, data: tx, backgroundColor: period === 'y' ? '#fb923c' : 'rgba(251,146,60,0.08)', borderColor: '#fb923c', tension: 0.3, fill: period !== 'y' }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: true }, tooltip: { enabled: true } },
                            scales: { y: { beginAtZero: true, title: { display: true, text: unit } } }
                        }
                    });
                },
                // 新增：统一重绘所有图表（窗口resize时调用）
                resizeAllCharts() {
                    // 重新渲染分钟图表
                    this.$nextTick(() => {
                        this.renderMinuteChart();
                        // 重新渲染所有统计图表
                        if (this.stats && this.stats.length) {
                            this.stats.forEach((stat, idx) => this.renderStatChart(idx));
                        }
                    });
                },
                async loadStats(stat, index) {
                    stat.loading = true;
                    try {
                        const response = await axios.get(`/api/stats/${this.selectedInterface}/${stat.period}`);
                        stat.data = response.data.data;
                        this.$nextTick(() => this.renderStatChart(index));
                        // 统一单位
                        const { labels, rx, tx } = this.parseStatData(stat.data);
                        const all = rx.concat(tx);
                        const { unit, factor } = this.getBestUnitAndFactor(all);
                        stat.unit = unit;
                        stat.factor = factor;
                    } catch (error) {
                        stat.data = ['错误: ' + (error.response?.data?.error || error.message)];
                    }
                    stat.loading = false;
                },
                async loadRealtimeStats() {
                    this.realtimeStats.loading = true;
                    try {
                        const response = await axios.get(`/api/stats/${this.selectedInterface}/l`);
                        // 解析实时数据
                        const rawData = response.data.data;
                        const parsedData = this.parseRealtimeData(rawData);
                        
                        if (parsedData) {
                            // 添加到历史数据，保持最近20条
                            this.realtimeData.push(parsedData);
                            if (this.realtimeData.length > 20) {
                                this.realtimeData.shift();
                            }
                            
                            // 更新图表和表格
                            this.$nextTick(() => {
                                this.renderRealtimeChart();
                                this.renderRealtimeTable();
                            });
                        }
                        
                        // 保持原有数据格式用于兼容
                        this.realtimeStats.data = rawData.filter(line => line.trim());
                    } catch (error) {
                        this.realtimeStats.data = ['错误: ' + (error.response?.data?.error || error.message)];
                    }
                    this.realtimeStats.loading = false;
                },
                parseRealtimeData(rawData) {
                    // 解析实时数据，提取速度和数据包信息
                    const receiveLine = rawData.find(line => line.includes('接收'));
                    const sendLine = rawData.find(line => line.includes('发送'));
                    
                    if (!receiveLine || !sendLine) {
                        console.warn('实时数据解析失败：未找到接收或发送行', rawData);
                        return null;
                    }
                    
                    // 增强的正则表达式，支持多种格式
                    // 格式1: 12345                   // 格式2: 123.45 kb/s 1234 packets/s
                    const speedPattern = /(\d+\.?\d*)\s*([kmg]?b\/秒).*?(\d+)\s*(数据包|packets|包|p)\/s/i;
                    
                    // 解析接收数据
                    const receiveMatch = receiveLine.match(speedPattern);
                    // 解析发送数据
                    const sendMatch = sendLine.match(speedPattern);
                    
                    if (!receiveMatch || !sendMatch) {
                        console.warn('实时数据解析失败：正则匹配失败', {
                            receiveLine,
                            sendLine,
                            receiveMatch,
                            sendMatch
                        });
                        return null;
                    }
                    
                    const now = new Date();
                    const parsedData = {
                        time: now.toLocaleTimeString(),
                        timestamp: now.getTime(),
                        receiveSpeed: parseFloat(receiveMatch[1]),
                        receiveSpeedUnit: receiveMatch[2],
                        receivePackets: parseInt(receiveMatch[3]),
                        sendSpeed: parseFloat(sendMatch[1]),
                        sendSpeedUnit: sendMatch[2],
                        sendPackets: parseInt(sendMatch[3])
                    };
                    
                    // 验证解析结果
                    if (isNaN(parsedData.receiveSpeed) || isNaN(parsedData.sendSpeed) || 
                        isNaN(parsedData.receivePackets) || isNaN(parsedData.sendPackets)) {
                        console.warn('实时数据解析失败：数值转换失败', parsedData);
                        return null;
                    }
                    
                    console.log('实时数据解析成功:', parsedData);
                    return parsedData;
                },
                renderRealtimeChart() {
                    if (this._realtimeChart) this._realtimeChart.destroy();
                    const ctx = this.$refs.realtimeChart;
                    if (!ctx) {
                        console.warn('实时图表渲染失败：canvas元素不存在');
                        return;
                    }
                    
                    // 设置canvas尺寸
                    ctx.height = 200;
                    const parent = ctx.parentElement;
                    if (parent) {
                        ctx.width = parent.clientWidth;
                    }
                    
                    // 准备图表数据（最近1分钟）
                    const oneMinuteAgo = Date.now() - 1 * 60 * 1000;
                    const chartData = this.realtimeData.filter(item => item.timestamp >= oneMinuteAgo);
                    
                    // 如果没有数据，创建默认数据点
                    let labels, receiveSpeeds, sendSpeeds;
                    if (chartData.length === 0) {
                        console.log('实时图表：使用默认数据');
                        const now = new Date();
                        labels = [now.toLocaleTimeString()];
                        receiveSpeeds = [0];
                        sendSpeeds = [0];
                    } else {
                        labels = chartData.map(item => item.time);
                        receiveSpeeds = chartData.map(item => item.receiveSpeed);
                        sendSpeeds = chartData.map(item => item.sendSpeed);
                    }
                    
                    this._realtimeChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [
                                { label: '接收速度', data: receiveSpeeds, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.08)', tension: 0.3, fill: true },
                                { label: '发送速度', data: sendSpeeds, borderColor: '#fb923c', backgroundColor: 'rgba(251,146,60,0.08)', tension: 0.3, fill: true }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: { 
                                legend: { display: true }, 
                                tooltip: { enabled: true } 
                            },
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    title: { display: true, text: '速度' } 
                                } 
                            }
                        }
                    });
                },
                renderRealtimeTable() {
                    if (this.realtimeData.length === 0) return;
                    
                    // 生成表格HTML
                    const tableData = this.realtimeData.slice(-20); // 最近20条
                    let html = `<div style='font-weight:bold;margin-bottom:4px;'>实时流量统计</div>`;
                    html += '<table class="table table-sm table-bordered mb-0" style="font-size:13px;">';
                    html += '<thead><tr><th>时间</th><th>接收速度</th><th>接收数据包</th><th>发送速度</th><th>发送数据包</th></tr></thead>';
                    html += '<tbody>';
                    
                    tableData.forEach((item, index) => {
                        const isLatest = index === tableData.length - 1;
                        const rowBg = isLatest ? '#e3f2fd' : (index % 2 === 0 ? '#fff' : '#f6f8fa');
                        const textColor = isLatest ? '#1976d2' : '';
                        html += `<tr style='background:${rowBg};${textColor ? 'color: ' + textColor + ';font-weight:bold;' : ''}'>`;
                        html += `<td>${item.time}</td>`;
                        html += `<td style='color:#2563eb;font-weight:500;'>${item.receiveSpeed} ${item.receiveSpeedUnit}</td>`;
                        html += `<td style='color:#2563eb;font-weight:500;'>${item.receivePackets} 包/s</td>`;
                        html += `<td style='color:#fb923c;font-weight:500;'>${item.sendSpeed} ${item.sendSpeedUnit}</td>`;
                        html += `<td style='color:#fb923c;font-weight:500;'>${item.sendPackets} 包/s</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // 更新表格内容
                    this.$refs.realtimeTable.innerHTML = html;
                },
                async loadMinuteStats() {
                    this.minuteStats.loading = true;
                    try {
                        const response = await axios.get(`/api/stats/${this.selectedInterface}/5`);
                        this.minuteStats.data = response.data.data.filter(line => line.trim());
                        this.$nextTick(() => this.renderMinuteChart());
                        // 统一单位
                        const { labels, rx, tx } = this.parseStatData(this.minuteStats.data);
                        const all = rx.concat(tx);
                        const { unit, factor } = this.getBestUnitAndFactor(all);
                        this.minuteStats.unit = unit;
                        this.minuteStats.factor = factor;
                    } catch (error) {
                        this.minuteStats.data = ['错误: ' + (error.response?.data?.error || error.message)];
                    }
                    this.minuteStats.loading = false;
                },
                loadAllStats() {
                    this.loadRealtimeStats();
                    this.loadMinuteStats();
                    this.stats.forEach((stat, idx) => this.loadStats(stat, idx));
                    this.updateLastUpdateTime();
                },
                updateLastUpdateTime() {
                    const now = new Date();
                    this.lastUpdateTime = now.toLocaleTimeString();
                },
                startAutoRefresh() {
                    if (this.refreshInterval) {
                        clearInterval(this.refreshInterval);
                    }
                    if (this.autoRefresh) {
                        this.refreshInterval = setInterval(() => {
                            this.loadRealtimeStats();
                            this.updateLastUpdateTime();
                        }, 1000);

                        setInterval(() => {
                            this.loadMinuteStats();
                        }, 5000);

                        setInterval(() => {
                            this.stats.forEach(stat => this.loadStats(stat));
                        }, 60000);
                    }
                },
                async loadVersion() {
                    try {
                        const response = await axios.get('/api/version');
                        this.version = response.data.version;
                    } catch (error) {
                        console.error('获取版本号失败:', error);
                    }
                },
                async queryDateRange() {
                    if (!this.isDateRangeValid) return;
                    
                    this.dateRangeStats.loading = true;
                    try {
                        const response = await axios.get(
                            `/api/stats/${this.selectedInterface}/range/${this.dateRange.start}/${this.dateRange.end}`
                        );
                        this.dateRangeStats.data = response.data.data;
                    } catch (error) {
                        this.error = '查询失败: ' + (error.response?.data?.error || error.message);
                    }
                    this.dateRangeStats.loading = false;
                },
                clearDateRangeStats() {
                    this.dateRangeStats.data = [];
                    this.dateRange.start = '';
                    this.dateRange.end = '';
                },
                // 新：将格式化后的数据渲染为HTML表格
                renderTableHtml(data, unit) {
                    if (!data || data.length === 0) return '';
                    // 第一行为标题（如 eth0 / 5 minute），单独一行
                    let html = `<div style='font-weight:bold;margin-bottom:4px;'>${data[0]}</div>`;
                    // 第二行为表头，严格保证5列：先用|分割，第一个分段再用多空格分割
                    let headerLine = data[1];
                    let header = [];
                    if (headerLine.includes('|')) {
                        const segs = headerLine.split('|');
                        header = segs[0].trim().split(/\s{2,}/).map(h => h.trim());
                        for (let i = 1; i < segs.length; i++) {
                            if (segs[i].trim()) header.push(segs[i].trim());
                        }
                    } else {
                        header = headerLine.split(/\s{2,}/).map(h => h.trim());
                    }
                    // 记录关键列索引
                    const rxIdx = header.findIndex(h => h.includes('接收'));
                    const txIdx = header.findIndex(h => h.includes('发送'));
                    const totalIdx = header.findIndex(h => h.includes('总计'));
                    const avgIdx = header.findIndex(h => h.includes('平均速率'));
                    html += '<table class="table table-sm table-bordered mb-0" style="font-size:13px;">';
                    html += '<thead><tr>' + header.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
                    html += '<tbody>';
                    // 其余为数据行，分割方式同上
                    let dataRowIdx = 0;
                    for (let i = 2; i < data.length; i++) {
                        let line = data[i];
                        if (line.includes('---')) continue;
                        let cols = [];
                        if (line.includes('|')) {
                            const segs = line.split('|');
                            cols = segs[0].trim().split(/\s{2,}/).map(c => c.trim());
                            for (let j = 1; j < segs.length; j++) {
                                if (segs[j].trim()) cols.push(segs[j].trim());
                            }
                        } else {
                            cols = line.split(/\s{2,}/).map(c => c.trim());
                        }
                        if (cols.length === 1 && !cols[0]) continue;
                        // 斑马纹背景色
                        const rowBg = dataRowIdx % 2 === 0 ? '#fff' : '#f6f8fa';
                        html += `<tr style='background:${rowBg};'>` +
                            cols.map((c, idx) => {
                                let style = '';
                                if (idx === rxIdx) style = 'color:#2563eb;font-weight:500;'; // 现代蓝
                                if (idx === txIdx) style = 'color:#fb923c;font-weight:500;'; // 现代橙
                                if (idx === totalIdx) style = 'color:#14b8a6;font-weight:500;'; // 现代青绿
                                if (idx === avgIdx) style = 'color:#64748b;font-weight:500;'; // 现代蓝灰
                                return `<td style='${style}'>${c}</td>`;
                            }).join('') + '</tr>';
                        dataRowIdx++;
                    }
                    html += '</tbody></table>';
                    return html;
                },
                toggleTheme() {
                    this.isDarkMode = !this.isDarkMode;
                    document.body.classList.toggle('dark', this.isDarkMode);
                    localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light');
                },
                applyThemeFromPreference() {
                    // 优先用户选择，默认浅色模式
                    const userTheme = localStorage.getItem('theme');
                    if (userTheme === 'dark') {
                        this.isDarkMode = true;
                        document.body.classList.add('dark');
                    } else {
                        // 默认浅色模式，移除系统主题跟随
                        this.isDarkMode = false;
                        document.body.classList.remove('dark');
                    }
                }
            },
            watch: {
                autoRefresh(newValue) {
                    if (newValue) {
                        this.startAutoRefresh();
                    } else {
                        clearInterval(this.refreshInterval);
                    }
                }
            },
            mounted() {
                this.loadInterfaces();
                this.startAutoRefresh();
                this.loadVersion();
                this.applyThemeFromPreference();
                // 新增：监听窗口resize事件
                window.addEventListener('resize', this.resizeAllCharts);
            },
            beforeUnmount() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                if (this._minuteChart) this._minuteChart.destroy();
                if (this._statCharts) this._statCharts.forEach(chart => chart.destroy());
                if (this._realtimeChart) this._realtimeChart.destroy(); // 移除实时图表
                // 新增：移除resize事件监听
                window.removeEventListener('resize', this.resizeAllCharts);
            }
        });

        app.mount('#app');
    </script>

    <!-- 51.la 统计代码 -->
    <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
    <script>LA.init({id:"24WADmnDKAw7Dh8r",ck:"24WADmnDKAw7Dh8r"})</script>

</body>
</html> 